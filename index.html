<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ ¬∑ –ö–æ–º–Ω–∞—Ç—ã</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.2s ease, color 0.1s ease, border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #1e1e1e;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #app {
            max-width: 1200px;
            width: 100%;
            background-color: #f8f8f8;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            padding: 32px;
            border: 1px solid #e0e0e0;
        }

        /* –õ–æ–±–±–∏ */
        #lobby h1 {
            font-weight: 400;
            font-size: 2.4rem;
            letter-spacing: -0.5px;
            margin-bottom: 32px;
            color: #2a2a2a;
            border-left: 5px solid #9e9e9e;
            padding-left: 24px;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .room-card {
            background-color: #ffffff;
            border-radius: 28px;
            padding: 28px 16px;
            text-align: center;
            border: 1px solid #d6d6d6;
            box-shadow: 0 6px 0 #c0c0c0;
            transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
        }

        .room-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 0 #b0b0b0;
            border-color: #a0a0a0;
        }

        .room-card.full {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .room-card h3 {
            font-size: 2rem;
            font-weight: 350;
            color: #333;
            margin-bottom: 12px;
        }

        .room-card p {
            font-size: 1.2rem;
            color: #5e5e5e;
            margin-bottom: 24px;
        }

        .room-card button {
            background-color: #eaeaea;
            border: 1px solid #bdbdbd;
            color: #1e1e1e;
            font-size: 1.3rem;
            padding: 14px 32px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 4px 0 #a0a0a0;
            transition: all 0.1s ease;
        }

        .room-card button:hover:not(:disabled) {
            background-color: #d5d5d5;
            border-color: #8f8f8f;
            transform: scale(0.97);
            box-shadow: 0 2px 0 #8a8a8a;
        }

        .room-card button:disabled {
            opacity: 0.4;
            cursor: default;
            box-shadow: none;
        }

        .rules {
            background-color: #ffffff;
            padding: 32px 36px;
            border-radius: 32px;
            border: 1px solid #dbdbdb;
            box-shadow: inset 0 1px 4px #eeeeee;
        }

        .rules h2 {
            font-weight: 400;
            color: #2b2b2b;
            margin-bottom: 18px;
            font-size: 2rem;
        }

        .rules p {
            color: #4a4a4a;
            line-height: 1.7;
            font-size: 1.2rem;
            max-width: 800px;
        }

        /* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
        #game {
            display: none;
        }

        .game-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .room-info h2 {
            font-size: 2rem;
            font-weight: 350;
            color: #2d2d2d;
        }

        .exit-btn {
            background: #ffffff;
            border: 1px solid #c0c0c0;
            color: #2a2a2a;
            font-size: 1.2rem;
            padding: 12px 32px;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 4px 0 #b0b0b0;
            transition: 0.1s;
        }

        .exit-btn:hover {
            background: #f0f0f0;
            border-color: #9e9e9e;
            transform: scale(0.97);
            box-shadow: 0 2px 0 #a0a0a0;
        }

        .player-badge {
            background-color: #ffffff;
            padding: 16px 32px;
            border-radius: 60px;
            display: inline-flex;
            align-items: center;
            gap: 18px;
            border: 1px solid #cacaca;
            margin-bottom: 25px;
            font-size: 1.5rem;
            box-shadow: 0 4px 0 #c0c0c0;
        }

        .symbol-icon {
            font-size: 2.2rem;
            font-weight: 600;
            background: #ececec;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #b0b0b0;
            color: #1e1e1e;
        }

        .turn-indicator {
            font-size: 1.7rem;
            margin-left: 8px;
            color: #3d3d3d;
            font-weight: 300;
            background: #f0f0f0;
            padding: 8px 26px;
            border-radius: 50px;
            display: inline-block;
            border: 1px solid #d2d2d2;
        }

        .scores {
            display: flex;
            gap: 50px;
            justify-content: center;
            font-size: 2rem;
            background: #ffffff;
            padding: 16px 40px;
            border-radius: 70px;
            margin-bottom: 25px;
            border: 1px solid #c4c4c4;
            box-shadow: 0 4px 0 #b8b8b8;
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .score-value {
            background: #eaeaea;
            padding: 6px 26px;
            border-radius: 40px;
            border: 1px solid #acacac;
            font-weight: 500;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 120px);
            gap: 12px;
            justify-content: center;
            margin: 35px 0;
        }

        .cell {
            width: 120px;
            height: 120px;
            background-color: #ffffff;
            border: 2px solid #c0c0c0;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: 300;
            color: #262626;
            cursor: pointer;
            box-shadow: 0 6px 0 #b0b0b0;
            transition: 0.08s linear;
        }

        .cell:not(.disabled):hover {
            background-color: #f5f5f5;
            border-color: #9c9c9c;
            transform: scale(0.97);
            box-shadow: 0 3px 0 #a0a0a0;
        }

        .cell.disabled {
            opacity: 0.45;
            cursor: not-allowed;
            box-shadow: none;
            border-color: #d4d4d4;
        }

        .rematch-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            margin-top: 20px;
        }

        #rematch-btn {
            background: #f0f0f0;
            border: 2px solid #b5b5b5;
            color: #1f1f1f;
            font-size: 1.9rem;
            padding: 16px 56px;
            border-radius: 70px;
            cursor: pointer;
            box-shadow: 0 6px 0 #a8a8a8;
            transition: 0.1s;
            width: fit-content;
            font-weight: 400;
        }

        #rematch-btn:not(:disabled):hover {
            background: #e2e2e2;
            border-color: #8f8f8f;
            transform: scale(0.97);
            box-shadow: 0 3px 0 #8a8a8a;
        }

        #rematch-btn:disabled {
            opacity: 0.3;
            cursor: default;
            box-shadow: none;
            border-color: #cfcfcf;
        }

        #rematch-status {
            font-size: 1.3rem;
            color: #5a5a5a;
            background: #eeeeee;
            padding: 8px 28px;
            border-radius: 50px;
            border: 1px solid #c9c9c9;
        }

        .footer-note {
            color: #b0b0b0;
            margin-top: 40px;
            text-align: center;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- –õ–æ–±–±–∏ —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏ -->
    <div id="lobby">
        <h1>‚ö™ –í–´–ë–ï–†–ò–¢–ï –ö–û–ú–ù–ê–¢–£ ‚ö´</h1>
        <div class="rooms-grid" id="rooms-container">
            <!-- –∫–æ–º–Ω–∞—Ç—ã –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <div class="rules">
            <h2>–ü–†–ê–í–ò–õ–ê</h2>
            <p>‚ú¶ –ò–≥—Ä–∞ –¥–æ —Ç—Ä—ë—Ö –ø–æ–±–µ–¥ –≤ —Å–µ—Ä–∏–∏.<br>
               ‚ú¶ –ü–µ—Ä–≤—ã–π —Ö–æ–¥ –≤—Å–µ–≥–¥–∞ –∑–∞ –∫—Ä–µ—Å—Ç–∏–∫–∞–º–∏.<br>
               ‚ú¶ –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏–∏ –¥–æ—Å–∫–∞ –æ—á–∏—â–∞–µ—Ç—Å—è, —Å—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.<br>
               ‚ú¶ –ö–æ–≥–¥–∞ –æ–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞–±–∏—Ä–∞–µ—Ç 3 –ø–æ–±–µ–¥—ã, –º–∞—Ç—á –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.<br>
               ‚ú¶ –ß—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞, –æ–±–∞ –¥–æ–ª–∂–Ω—ã –Ω–∞–∂–∞—Ç—å ¬´–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞¬ª.</p>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
    <div id="game">
        <div class="game-header">
            <div class="room-info">
                <h2 id="game-room-title">–ö–æ–º–Ω–∞—Ç–∞</h2>
            </div>
            <button class="exit-btn" id="exit-game-btn">‚áΩ –í—ã–π—Ç–∏</button>
        </div>

        <div class="player-badge" id="player-badge">
            <span>—Ç—ã –∏–≥—Ä–∞–µ—à—å –∑–∞</span>
            <span class="symbol-icon" id="your-symbol">‚ùî</span>
        </div>

        <div class="turn-indicator" id="turn-status">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</div>

        <div class="scores">
            <div class="score-item">X <span class="score-value" id="score-x">0</span></div>
            <div class="score-item">O <span class="score-value" id="score-o">0</span></div>
        </div>

        <div class="board" id="board"></div>

        <div class="rematch-area">
            <button id="rematch-btn" disabled>–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞ 0/2</button>
            <div id="rematch-status"></div>
        </div>
    </div>
    <div class="footer-note">‚ö™‚ö´ –ú–ò–ù–ò–ú–ê–õ–ò–ó–ú ‚Ä¢ –ë–ï–õ–´–ô ‚Ä¢ –°–ï–†–´–ô ‚Ä¢ –ß–Å–†–ù–´–ô</div>
</div>

<script type="module">
    // ========== FIREBASE ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDsiylf6dcAs8rstgLuO8ea6XHWruBKrJU",
        authDomain: "tic-tac-toe-rooms.firebaseapp.com",
        projectId: "tic-tac-toe-rooms",
        storageBucket: "tic-tac-toe-rooms.appspot.com",
        messagingSenderId: "831043796703",
        appId: "1:831043796703:web:aa22df01b2ba9fdef0b36a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    const myId = localStorage.getItem('playerId') || crypto.randomUUID();
    localStorage.setItem('playerId', myId);

    let currentRoomId = null;
    let roomUnsubscribe = null;
    let mySymbol = null;

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const lobbyDiv = document.getElementById('lobby');
    const gameDiv = document.getElementById('game');
    const roomsContainer = document.getElementById('rooms-container');
    const gameRoomTitle = document.getElementById('game-room-title');
    const yourSymbolSpan = document.getElementById('your-symbol');
    const turnStatus = document.getElementById('turn-status');
    const scoreXSpan = document.getElementById('score-x');
    const scoreOSpan = document.getElementById('score-o');
    const boardDiv = document.getElementById('board');
    const rematchBtn = document.getElementById('rematch-btn');
    const rematchStatus = document.getElementById('rematch-status');
    const exitGameBtn = document.getElementById('exit-game-btn');

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function showLobby() {
        if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }
        currentRoomId = null;
        mySymbol = null;
        lobbyDiv.style.display = 'block';
        gameDiv.style.display = 'none';
        loadRooms();
    }

    function showGame(roomId) {
        lobbyDiv.style.display = 'none';
        gameDiv.style.display = 'block';
        gameRoomTitle.textContent = `–ö–æ–º–Ω–∞—Ç–∞ ${roomId}`;
    }

    // ========== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò ==========
    async function restoreSession() {
        const roomsRef = collection(db, 'rooms');
        const snapshot = await getDocs(roomsRef);
        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            if (data.player1Id === myId || data.player2Id === myId) {
                const roomId = docSnap.id;
                currentRoomId = roomId;
                if (roomUnsubscribe) roomUnsubscribe();
                roomUnsubscribe = onSnapshot(doc(db, 'rooms', roomId), (docSnap) => {
                    if (!docSnap.exists()) return;
                    handleRoomUpdate(roomId, docSnap.data());
                });
                showGame(roomId);
                return true;
            }
        }
        return false;
    }

    // ========== –õ–û–ë–ë–ò: –ó–ê–ì–†–£–ó–ö–ê –ö–û–ú–ù–ê–¢ ==========
    async function ensureRoomsExist() {
        const roomIds = ['room1', 'room2', 'room3'];
        for (const id of roomIds) {
            const ref = doc(db, 'rooms', id);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                await setDoc(ref, {
                    player1Id: null,
                    player2Id: null,
                    player1Symbol: null,
                    player2Symbol: null,
                    game: {
                        board: Array(9).fill(null),
                        currentTurn: 'X',
                        winner: null,
                        scores: { X: 0, O: 0 },
                        status: 'waiting',
                        rematch: { player1: false, player2: false }
                    }
                });
            }
        }
    }

    async function loadRooms() {
        await ensureRoomsExist();
        const roomsQuery = query(collection(db, 'rooms'));
        onSnapshot(roomsQuery, (snapshot) => {
            const rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderRooms(rooms);
        });
    }

    function renderRooms(rooms) {
        roomsContainer.innerHTML = '';
        rooms.forEach(room => {
            const count = (room.player1Id ? 1 : 0) + (room.player2Id ? 1 : 0);
            const card = document.createElement('div');
            card.className = `room-card ${count === 2 ? 'full' : ''}`;
            card.innerHTML = `
                <h3>üö™ ${room.id}</h3>
                <p>–ò–≥—Ä–æ–∫–æ–≤: ${count}/2</p>
                <button ${count === 2 ? 'disabled' : ''} data-room="${room.id}">–í–æ–π—Ç–∏</button>
            `;
            card.querySelector('button').addEventListener('click', () => joinRoom(room.id));
            roomsContainer.appendChild(card);
        });
    }

    // ========== –£–õ–£–ß–®–ï–ù–ù–´–ô –í–•–û–î –í –ö–û–ú–ù–ê–¢–£ (—Å –æ—á–∏—Å—Ç–∫–æ–π "–∑–∞–≤–∏—Å—à–∏—Ö" –∏–≥—Ä–æ–∫–æ–≤) ==========
    async function joinRoom(roomId) {
        if (currentRoomId) {
            if (currentRoomId === roomId) return;
            else await leaveRoom();
        }

        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) return;

        let data = roomSnap.data();

        // --- –û—á–∏—Å—Ç–∫–∞ "–∑–∞–≤–∏—Å—à–∏—Ö" –∏–≥—Ä–æ–∫–æ–≤ ---
        const updates = {};
        if (data.player1Id && data.player1Id !== myId && !data.player2Id) {
            console.log(`üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–µ–≥–æ player1 –≤ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
            updates.player1Id = null;
            updates.player1Symbol = null;
        }
        if (data.player2Id && data.player2Id !== myId && !data.player1Id) {
            console.log(`üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–µ–≥–æ player2 –≤ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
            updates.player2Id = null;
            updates.player2Symbol = null;
        }
        if (Object.keys(updates).length > 0) {
            await updateDoc(roomRef, updates);
            const freshSnap = await getDoc(roomRef);
            data = freshSnap.data();
        }
        // --- –ö–æ–Ω–µ—Ü –æ—á–∏—Å—Ç–∫–∏ ---

        if (data.player1Id && data.player2Id) {
            alert('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
            return;
        }

        // –ó–∞–Ω–∏–º–∞–µ–º –º–µ—Å—Ç–æ
        const joinUpdate = {};
        if (!data.player1Id) joinUpdate.player1Id = myId;
        else if (!data.player2Id) joinUpdate.player2Id = myId;
        else return;

        await updateDoc(roomRef, joinUpdate);

        if (roomUnsubscribe) roomUnsubscribe();
        roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
            if (!docSnap.exists()) return;
            handleRoomUpdate(roomId, docSnap.data());
        });

        currentRoomId = roomId;
        showGame(roomId);
    }

    // ========== –í–´–•–û–î –ò–ó –ö–û–ú–ù–ê–¢–´ ==========
    async function leaveRoom() {
        if (!currentRoomId) return;
        const roomRef = doc(db, 'rooms', currentRoomId);
        const snap = await getDoc(roomRef);
        if (snap.exists()) {
            const data = snap.data();
            const update = {};

            if (data.player1Id === myId) {
                update.player1Id = null;
                update.player1Symbol = null;
            }
            if (data.player2Id === myId) {
                update.player2Id = null;
                update.player2Symbol = null;
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–≥—Ä—É
            update.game = {
                board: Array(9).fill(null),
                currentTurn: 'X',
                winner: null,
                scores: { X: 0, O: 0 },
                status: 'waiting',
                rematch: { player1: false, player2: false }
            };

            await updateDoc(roomRef, update);
        }

        if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }
        currentRoomId = null;
        mySymbol = null;
        showLobby();
    }

    exitGameBtn.addEventListener('click', leaveRoom);

    // ========== –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–ô –ö–û–ú–ù–ê–¢–´ ==========
    async function handleRoomUpdate(roomId, data) {
        const amPlayer1 = data.player1Id === myId;
        const amPlayer2 = data.player2Id === myId;
        if (!amPlayer1 && !amPlayer2) {
            alert('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
            showLobby();
            return;
        }

        if (data.player1Id && data.player2Id && !data.player1Symbol && !data.player2Symbol) {
            await assignSymbols(roomId, data.player1Id, data.player2Id);
            return;
        }

        if (amPlayer1) mySymbol = data.player1Symbol;
        if (amPlayer2) mySymbol = data.player2Symbol;

        updateGameUI(data);
    }

    async function assignSymbols(roomId, p1Id, p2Id) {
        const random = Math.random() < 0.5;
        const p1Symbol = random ? 'X' : 'O';
        const p2Symbol = random ? 'O' : 'X';
        const roomRef = doc(db, 'rooms', roomId);
        await updateDoc(roomRef, {
            player1Symbol: p1Symbol,
            player2Symbol: p2Symbol,
            'game.status': 'playing',
            'game.currentTurn': 'X'
        });
    }

    // ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ì–†–û–í–û–ì–û –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
    function updateGameUI(data) {
        const isPlayer1 = data.player1Id === myId;
        const mySym = isPlayer1 ? data.player1Symbol : data.player2Symbol;
        yourSymbolSpan.textContent = mySym || '?';

        scoreXSpan.textContent = data.game.scores.X;
        scoreOSpan.textContent = data.game.scores.O;

        if (data.game.status === 'waiting') {
            turnStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
        } else if (data.game.status === 'finished') {
            turnStatus.textContent = data.game.scores.X === 3 ? '‚úò –ü–æ–±–µ–¥–∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫–∏ (–º–∞—Ç—á)' : '‚óØ –ü–æ–±–µ–¥–∏–ª–∏ –Ω–æ–ª–∏–∫–∏ (–º–∞—Ç—á)';
        } else if (data.game.status === 'playing') {
            if (!mySym) turnStatus.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤...';
            else {
                const isMyTurn = (data.game.currentTurn === mySym);
                turnStatus.textContent = isMyTurn ? '‚úÖ –í–∞—à —Ö–æ–¥' : '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
            }
        }

        renderBoard(data.game.board, data.game.status === 'playing' && data.game.currentTurn === mySym, data.game.status === 'finished');

        const rematchState = data.game.rematch || { player1: false, player2: false };
        const p1Pressed = data.player1Id ? rematchState.player1 : false;
        const p2Pressed = data.player2Id ? rematchState.player2 : false;
        const countPressed = (p1Pressed ? 1 : 0) + (p2Pressed ? 1 : 0);

        rematchBtn.textContent = `–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞ ${countPressed}/2`;
        rematchStatus.textContent = countPressed === 2 ? '‚úî –û–±–∞ –≥–æ—Ç–æ–≤—ã. –ù–æ–≤–∞—è –∏–≥—Ä–∞!' : '';

        const matchEnded = data.game.scores.X >= 3 || data.game.scores.O >= 3;
        rematchBtn.disabled = !matchEnded;

        if (matchEnded && countPressed === 2) {
            resetGameAfterRematch(currentRoomId);
        }
    }

    function renderBoard(boardArray, canMove, gameFinished) {
        boardDiv.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.className = `cell ${(!canMove || gameFinished) ? 'disabled' : ''}`;
            cell.textContent = boardArray[i] || '';
            if (!gameFinished && canMove && boardArray[i] === null) {
                cell.addEventListener('click', () => makeMove(i));
            }
            boardDiv.appendChild(cell);
        }
    }

    // ========== –•–û–î ==========
    async function makeMove(index) {
        if (!currentRoomId) return;
        const roomRef = doc(db, 'rooms', currentRoomId);
        const snap = await getDoc(roomRef);
        if (!snap.exists()) return;
        const data = snap.data();
        if (data.game.status !== 'playing') return;
        if (data.game.currentTurn !== mySymbol) return;
        if (data.game.board[index] !== null) return;

        const newBoard = [...data.game.board];
        newBoard[index] = mySymbol;

        const winInfo = checkWinner(newBoard);
        let newScores = { ...data.game.scores };
        let newStatus = 'playing';
        let nextTurn = mySymbol === 'X' ? 'O' : 'X';
        let boardAfterWin = newBoard;

        if (winInfo.winner) {
            newScores[winInfo.winner] += 1;
            if (newScores.X >= 3 || newScores.O >= 3) {
                newStatus = 'finished';
            } else {
                boardAfterWin = Array(9).fill(null);
                nextTurn = 'X';
            }
        } else if (winInfo.draw) {
            boardAfterWin = Array(9).fill(null);
            nextTurn = 'X';
        }

        const update = {
            'game.board': boardAfterWin,
            'game.currentTurn': nextTurn,
            'game.scores': newScores,
            'game.status': newStatus
        };

        await updateDoc(roomRef, update);
    }

    function checkWinner(board) {
        const lines = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for (let line of lines) {
            const [a,b,c] = line;
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                return { winner: board[a], draw: false };
            }
        }
        if (board.every(cell => cell !== null)) return { winner: null, draw: true };
        return { winner: null, draw: false };
    }

    // ========== –†–ï–ú–ê–¢–ß ==========
    rematchBtn.addEventListener('click', async () => {
        if (!currentRoomId) return;
        const roomRef = doc(db, 'rooms', currentRoomId);
        const snap = await getDoc(roomRef);
        if (!snap.exists()) return;
        const data = snap.data();
        const isPlayer1 = data.player1Id === myId;
        const isPlayer2 = data.player2Id === myId;

        const update = {};
        if (isPlayer1) update['game.rematch.player1'] = true;
        if (isPlayer2) update['game.rematch.player2'] = true;

        await updateDoc(roomRef, update);
    });

    async function resetGameAfterRematch(roomId) {
        if (!roomId) return;
        const roomRef = doc(db, 'rooms', roomId);
        const snap = await getDoc(roomRef);
        if (!snap.exists()) return;
        const data = snap.data();
        if (data.game.rematch?.player1 && data.game.rematch?.player2) {
            await updateDoc(roomRef, {
                'game.board': Array(9).fill(null),
                'game.currentTurn': 'X',
                'game.scores': { X:0, O:0 },
                'game.status': 'playing',
                'game.rematch': { player1: false, player2: false }
            });
        }
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    (async () => {
        await ensureRoomsExist();
        // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é
        const restored = await restoreSession();
        if (!restored) {
            loadRooms();
            showLobby();
        }
    })();
</script>
</body>
</html>