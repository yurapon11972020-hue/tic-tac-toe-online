<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ ¬∑ –ö–æ–º–Ω–∞—Ç—ã</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ */
        /* –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –ø–æ–ª–Ω—ã–π CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
        /* ... (–¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è –Ω–µ –∫–æ–ø–∏—Ä—É—é –∏—Ö, –Ω–æ –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å) */
    </style>
</head>
<body>
<div id="app">
    <!-- –õ–æ–±–±–∏ —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏ -->
    <div id="lobby">
        <h1>‚ö™ –í–´–ë–ï–†–ò–¢–ï –ö–û–ú–ù–ê–¢–£ ‚ö´</h1>
        <div class="rooms-grid" id="rooms-container">
            <!-- –∫–æ–º–Ω–∞—Ç—ã –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <div class="rules">
            <h2>–ü–†–ê–í–ò–õ–ê</h2>
            <p>‚ú¶ –ò–≥—Ä–∞ –¥–æ —Ç—Ä—ë—Ö –ø–æ–±–µ–¥ –≤ —Å–µ—Ä–∏–∏.<br>
               ‚ú¶ –ü–µ—Ä–≤—ã–π —Ö–æ–¥ –≤—Å–µ–≥–¥–∞ –∑–∞ –∫—Ä–µ—Å—Ç–∏–∫–∞–º–∏.<br>
               ‚ú¶ –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏–∏ –¥–æ—Å–∫–∞ –æ—á–∏—â–∞–µ—Ç—Å—è, —Å—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.<br>
               ‚ú¶ –ö–æ–≥–¥–∞ –æ–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞–±–∏—Ä–∞–µ—Ç 3 –ø–æ–±–µ–¥—ã, –º–∞—Ç—á –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.<br>
               ‚ú¶ –ß—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞, –æ–±–∞ –¥–æ–ª–∂–Ω—ã –Ω–∞–∂–∞—Ç—å ¬´–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞¬ª.</p>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
    <div id="game">
        <div class="game-header">
            <div class="room-info">
                <h2 id="game-room-title">–ö–æ–º–Ω–∞—Ç–∞</h2>
            </div>
            <button class="exit-btn" id="exit-game-btn">‚áΩ –í—ã–π—Ç–∏</button>
        </div>

        <div class="player-badge" id="player-badge">
            <span>—Ç—ã –∏–≥—Ä–∞–µ—à—å –∑–∞</span>
            <span class="symbol-icon" id="your-symbol">‚ùî</span>
        </div>

        <div class="turn-indicator" id="turn-status">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</div>

        <div class="scores">
            <div class="score-item">X <span class="score-value" id="score-x">0</span></div>
            <div class="score-item">O <span class="score-value" id="score-o">0</span></div>
        </div>

        <div class="board" id="board"></div>

        <div class="rematch-area">
            <button id="rematch-btn" disabled>–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞ 0/2</button>
            <div id="rematch-status"></div>
        </div>
    </div>
    <div class="footer-note">‚ö™‚ö´ –ú–ò–ù–ò–ú–ê–õ–ò–ó–ú ‚Ä¢ –ë–ï–õ–´–ô ‚Ä¢ –°–ï–†–´–ô ‚Ä¢ –ß–Å–†–ù–´–ô</div>
</div>

<script type="module">
    // ========== FIREBASE ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDsiylf6dcAs8rstgLuO8ea6XHWruBKrJU",
        authDomain: "tic-tac-toe-rooms.firebaseapp.com",
        projectId: "tic-tac-toe-rooms",
        storageBucket: "tic-tac-toe-rooms.appspot.com",
        messagingSenderId: "831043796703",
        appId: "1:831043796703:web:aa22df01b2ba9fdef0b36a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    const myId = localStorage.getItem('playerId') || crypto.randomUUID();
    localStorage.setItem('playerId', myId);

    let currentRoomId = null;
    let roomUnsubscribe = null;
    let mySymbol = null;
    let isLeaving = false; // —Ñ–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const lobbyDiv = document.getElementById('lobby');
    const gameDiv = document.getElementById('game');
    const roomsContainer = document.getElementById('rooms-container');
    const gameRoomTitle = document.getElementById('game-room-title');
    const yourSymbolSpan = document.getElementById('your-symbol');
    const turnStatus = document.getElementById('turn-status');
    const scoreXSpan = document.getElementById('score-x');
    const scoreOSpan = document.getElementById('score-o');
    const boardDiv = document.getElementById('board');
    const rematchBtn = document.getElementById('rematch-btn');
    const rematchStatus = document.getElementById('rematch-status');
    const exitGameBtn = document.getElementById('exit-game-btn');

    // ========== –û–ß–ò–°–¢–ö–ê "–ó–ê–í–ò–°–®–ò–•" –ö–û–ú–ù–ê–¢ ==========
    async function cleanStaleRooms() {
        console.log("üßπ –û—á–∏—Å—Ç–∫–∞ –∫–æ–º–Ω–∞—Ç –æ—Ç –ø—Ä–∏–∑—Ä–∞–∫–æ–≤...");
        const roomsRef = collection(db, 'rooms');
        const snapshot = await getDocs(roomsRef);
        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            const roomId = docSnap.id;
            let updates = {};

            if (data.player1Id && !data.player2Id && data.player1Id !== myId) {
                updates.player1Id = null;
                updates.player1Symbol = null;
            }
            if (data.player2Id && !data.player1Id && data.player2Id !== myId) {
                updates.player2Id = null;
                updates.player2Symbol = null;
            }

            if (Object.keys(updates).length > 0) {
                console.log(`üßπ –û—á–∏—Å—Ç–∫–∞ –∫–æ–º–Ω–∞—Ç—ã ${roomId}`);
                await updateDoc(doc(db, 'rooms', roomId), updates);
            }
        }
    }

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ==========
    function showLobby() {
        if (roomUnsubscribe) {
            roomUnsubscribe();
            roomUnsubscribe = null;
        }
        currentRoomId = null;
        mySymbol = null;
        lobbyDiv.style.display = 'block';
        gameDiv.style.display = 'none';
        loadRooms(); // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
    }

    function showGame(roomId) {
        lobbyDiv.style.display = 'none';
        gameDiv.style.display = 'block';
        gameRoomTitle.textContent = `–ö–æ–º–Ω–∞—Ç–∞ ${roomId}`;
    }

    // ========== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò ==========
    async function restoreSession() {
        const roomsRef = collection(db, 'rooms');
        const snapshot = await getDocs(roomsRef);
        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            if (data.player1Id === myId || data.player2Id === myId) {
                const roomId = docSnap.id;
                // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ, –Ω–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ
                if (currentRoomId === roomId) return true;
                // –ï—Å–ª–∏ –º—ã –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–Ω–∞—Ç–µ, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–µ–º
                if (currentRoomId) await leaveRoom();

                currentRoomId = roomId;
                if (roomUnsubscribe) roomUnsubscribe();
                roomUnsubscribe = onSnapshot(doc(db, 'rooms', roomId), (docSnap) => {
                    if (!docSnap.exists()) return;
                    handleRoomUpdate(roomId, docSnap.data());
                });
                showGame(roomId);
                return true;
            }
        }
        return false;
    }

    // ========== –õ–û–ë–ë–ò: –ó–ê–ì–†–£–ó–ö–ê –ö–û–ú–ù–ê–¢ ==========
    async function ensureRoomsExist() {
        const roomIds = ['room1', 'room2', 'room3'];
        for (const id of roomIds) {
            const ref = doc(db, 'rooms', id);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                await setDoc(ref, {
                    player1Id: null,
                    player2Id: null,
                    player1Symbol: null,
                    player2Symbol: null,
                    game: {
                        board: Array(9).fill(null),
                        currentTurn: 'X',
                        winner: null,
                        scores: { X: 0, O: 0 },
                        status: 'waiting',
                        rematch: { player1: false, player2: false }
                    }
                });
            }
        }
    }

    async function loadRooms() {
        await ensureRoomsExist();
        const roomsQuery = query(collection(db, 'rooms'));
        onSnapshot(roomsQuery, (snapshot) => {
            const rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderRooms(rooms);
        });
    }

    function renderRooms(rooms) {
        roomsContainer.innerHTML = '';
        rooms.forEach(room => {
            const count = (room.player1Id ? 1 : 0) + (room.player2Id ? 1 : 0);
            const card = document.createElement('div');
            card.className = `room-card ${count === 2 ? 'full' : ''}`;
            card.innerHTML = `
                <h3>üö™ ${room.id}</h3>
                <p>–ò–≥—Ä–æ–∫–æ–≤: ${count}/2</p>
                <button ${count === 2 ? 'disabled' : ''} data-room="${room.id}">–í–æ–π—Ç–∏</button>
            `;
            card.querySelector('button').addEventListener('click', () => joinRoom(room.id));
            roomsContainer.appendChild(card);
        });
    }

    // ========== –í–•–û–î –í –ö–û–ú–ù–ê–¢–£ ==========
    async function joinRoom(roomId) {
        // –ï—Å–ª–∏ —É–∂–µ –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (currentRoomId === roomId) return;
        // –ï—Å–ª–∏ –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–Ω–∞—Ç–µ ‚Äî –≤—ã—Ö–æ–¥–∏–º
        if (currentRoomId) await leaveRoom();

        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) return;

        let data = roomSnap.data();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –Ω–∞–º–∏ –∂–µ (–¥—É–±–ª–∏—Ä—É—é—â–∞—è —Å–µ—Å—Å–∏—è)
        if (data.player1Id === myId || data.player2Id === myId) {
            // –ú—ã —É–∂–µ —á–∏—Å–ª–∏–º—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ (–≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
            // –ü—Ä–æ—Å—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
            currentRoomId = roomId;
            if (roomUnsubscribe) roomUnsubscribe();
            roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
                if (!docSnap.exists()) return;
                handleRoomUpdate(roomId, docSnap.data());
            });
            showGame(roomId);
            return;
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤, –µ—Å–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ –ø–æ–ª–Ω–∞—è
        const updates = {};
        if (data.player1Id && !data.player2Id && data.player1Id !== myId) {
            updates.player1Id = null;
            updates.player1Symbol = null;
        }
        if (data.player2Id && !data.player1Id && data.player2Id !== myId) {
            updates.player2Id = null;
            updates.player2Symbol = null;
        }
        if (Object.keys(updates).length > 0) {
            await updateDoc(roomRef, updates);
            const freshSnap = await getDoc(roomRef);
            data = freshSnap.data();
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–Ω–∞ –ª–∏ —Ç–µ–ø–µ—Ä—å
        if (data.player1Id && data.player2Id) {
            alert('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
            return;
        }

        // –ó–∞–Ω–∏–º–∞–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
        const joinUpdate = {};
        if (!data.player1Id) joinUpdate.player1Id = myId;
        else if (!data.player2Id) joinUpdate.player2Id = myId;
        else return;

        await updateDoc(roomRef, joinUpdate);

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
        if (roomUnsubscribe) roomUnsubscribe();
        roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
            if (!docSnap.exists()) return;
            handleRoomUpdate(roomId, docSnap.data());
        });

        currentRoomId = roomId;
        showGame(roomId);
    }

    // ========== –í–´–•–û–î –ò–ó –ö–û–ú–ù–ê–¢–´ ==========
    async function leaveRoom() {
        if (!currentRoomId || isLeaving) return;
        isLeaving = true;

        const roomRef = doc(db, 'rooms', currentRoomId);
        const snap = await getDoc(roomRef);
        if (snap.exists()) {
            const data = snap.data();
            const update = {};

            if (data.player1Id === myId) {
                update.player1Id = null;
                update.player1Symbol = null;
            }
            if (data.player2Id === myId) {
                update.player2Id = null;
                update.player2Symbol = null;
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–≥—Ä—É
            update.game = {
                board: Array(9).fill(null),
                currentTurn: 'X',
                winner: null,
                scores: { X: 0, O: 0 },
                status: 'waiting',
                rematch: { player1: false, player2: false }
            };

            await updateDoc(roomRef, update);
        }

        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ª–æ–±–±–∏
        if (roomUnsubscribe) {
            roomUnsubscribe();
            roomUnsubscribe = null;
        }
        currentRoomId = null;
        mySymbol = null;
        isLeaving = false;
        showLobby();
    }

    exitGameBtn.addEventListener('click', leaveRoom);

    // ========== –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–ô –ö–û–ú–ù–ê–¢–´ ==========
    async function handleRoomUpdate(roomId, data) {
        const amPlayer1 = data.player1Id === myId;
        const amPlayer2 = data.player2Id === myId;

        // –ï—Å–ª–∏ –Ω–∞—Å –Ω–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ ‚Äî –≤—ã—Ö–æ–¥–∏–º –≤ –ª–æ–±–±–∏
        if (!amPlayer1 && !amPlayer2) {
            // –ù–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–∑–≤–∞–Ω–æ –ª–∏ —ç—Ç–æ –Ω–∞—à–∏–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã—Ö–æ–¥–æ–º (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–µ–≥–æ –∞–ª–µ—Ä—Ç–∞)
            if (!isLeaving && currentRoomId === roomId) {
                alert('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
            }
            if (roomUnsubscribe) {
                roomUnsubscribe();
                roomUnsubscribe = null;
            }
            currentRoomId = null;
            mySymbol = null;
            showLobby();
            return;
        }

        // –ï—Å–ª–∏ –æ–±–∞ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –º–µ—Å—Ç–µ, –Ω–æ —Å–∏–º–≤–æ–ª—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ–º
        if (data.player1Id && data.player2Id && !data.player1Symbol && !data.player2Symbol) {
            await assignSymbols(roomId, data.player1Id, data.player2Id);
            return;
        }

        if (amPlayer1) mySymbol = data.player1Symbol;
        if (amPlayer2) mySymbol = data.player2Symbol;

        updateGameUI(data);
    }

    async function assignSymbols(roomId, p1Id, p2Id) {
        const random = Math.random() < 0.5;
        const p1Symbol = random ? 'X' : 'O';
        const p2Symbol = random ? 'O' : 'X';
        const roomRef = doc(db, 'rooms', roomId);
        await updateDoc(roomRef, {
            player1Symbol: p1Symbol,
            player2Symbol: p2Symbol,
            'game.status': 'playing',
            'game.currentTurn': 'X'
        });
    }

    // ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ì–†–û–í–û–ì–û –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
    function updateGameUI(data) {
        const isPlayer1 = data.player1Id === myId;
        const mySym = isPlayer1 ? data.player1Symbol : data.player2Symbol;
        yourSymbolSpan.textContent = mySym || '?';

        scoreXSpan.textContent = data.game.scores.X;
        scoreOSpan.textContent = data.game.scores.O;

        if (data.game.status === 'waiting') {
            turnStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
        } else if (data.game.status === 'finished') {
            turnStatus.textContent = data.game.scores.X === 3 ? '‚úò –ü–æ–±–µ–¥–∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫–∏ (–º–∞—Ç—á)' : '‚óØ –ü–æ–±–µ–¥–∏–ª–∏ –Ω–æ–ª–∏–∫–∏ (–º–∞—Ç—á)';
        } else if (data.game.status === 'playing') {
            if (!mySym) turnStatus.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤...';
            else {
                const isMyTurn = (data.game.currentTurn === mySym);
                turnStatus.textContent = isMyTurn ? '‚úÖ –í–∞—à —Ö–æ–¥' : '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
            }
        }

        renderBoard(data.game.board, data.game.status === 'playing' && data.game.currentTurn === mySym, data.game.status === 'finished');

        const rematchState = data.game.rematch || { player1: false, player2: false };
        const p1Pressed = data.player1Id ? rematchState.player1 : false;
        const p2Pressed = data.player2Id ? rematchState.player2 : false;
        const countPressed = (p1Pressed ? 1 : 0) + (p2Pressed ? 1 : 0);

        rematchBtn.textContent = `–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞ ${countPressed}/2`;
        rematchStatus.textContent = countPressed === 2 ? '‚úî –û–±–∞ –≥–æ—Ç–æ–≤—ã. –ù–æ–≤–∞—è –∏–≥—Ä–∞!' : '';

        const matchEnded = data.game.scores.X >= 3 || data.game.scores.O >= 3;
        rematchBtn.disabled = !matchEnded;

        if (matchEnded && countPressed === 2) {
            resetGameAfterRematch(currentRoomId);
        }
    }

    function renderBoard(boardArray, canMove, gameFinished) {
        boardDiv.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.className = `cell ${(!canMove || gameFinished) ? 'disabled' : ''}`;
            cell.textContent = boardArray[i] || '';
            if (!gameFinished && canMove && boardArray[i] === null) {
                cell.addEventListener('click', () => makeMove(i));
            }
            boardDiv.appendChild(cell);
        }
    }

    // ========== –•–û–î ==========
    async function makeMove(index) {
        if (!currentRoomId) return;
        const roomRef = doc(db, 'rooms', currentRoomId);
        const snap = await getDoc(roomRef);
        if (!snap.exists()) return;
        const data = snap.data();
        if (data.game.status !== 'playing') return;
        if (data.game.currentTurn !== mySymbol) return;
        if (data.game.board[index] !== null) return;

        const newBoard = [...data.game.board];
        newBoard[index] = mySymbol;

        const winInfo = checkWinner(newBoard);
        let newScores = { ...data.game.scores };
        let newStatus = 'playing';
        let nextTurn = mySymbol === 'X' ? 'O' : 'X';
        let boardAfterWin = newBoard;

        if (winInfo.winner) {
            newScores[winInfo.winner] += 1;
            if (newScores.X >= 3 || newScores.O >= 3) {
                newStatus = 'finished';
            } else {
                boardAfterWin = Array(9).fill(null);
                nextTurn = 'X';
            }
        } else if (winInfo.draw) {
            boardAfterWin = Array(9).fill(null);
            nextTurn = 'X';
        }

        const update = {
            'game.board': boardAfterWin,
            'game.currentTurn': nextTurn,
            'game.scores': newScores,
            'game.status': newStatus
        };

        await updateDoc(roomRef, update);
    }

    function checkWinner(board) {
        const lines = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for (let line of lines) {
            const [a,b,c] = line;
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                return { winner: board[a], draw: false };
            }
        }
        if (board.every(cell => cell !== null)) return { winner: null, draw: true };
        return { winner: null, draw: false };
    }

    // ========== –†–ï–ú–ê–¢–ß ==========
    rematchBtn.addEventListener('click', async () => {
        if (!currentRoomId) return;
        const roomRef = doc(db, 'rooms', currentRoomId);
        const snap = await getDoc(roomRef);
        if (!snap.exists()) return;
        const data = snap.data();
        const isPlayer1 = data.player1Id === myId;
        const isPlayer2 = data.player2Id === myId;

        const update = {};
        if (isPlayer1) update['game.rematch.player1'] = true;
        if (isPlayer2) update['game.rematch.player2'] = true;

        await updateDoc(roomRef, update);
    });

    async function resetGameAfterRematch(roomId) {
        if (!roomId) return;
        const roomRef = doc(db, 'rooms', roomId);
        const snap = await getDoc(roomRef);
        if (!snap.exists()) return;
        const data = snap.data();
        if (data.game.rematch?.player1 && data.game.rematch?.player2) {
            await updateDoc(roomRef, {
                'game.board': Array(9).fill(null),
                'game.currentTurn': 'X',
                'game.scores': { X:0, O:0 },
                'game.status': 'playing',
                'game.rematch': { player1: false, player2: false }
            });
        }
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    (async () => {
        await ensureRoomsExist();
        await cleanStaleRooms();
        const restored = await restoreSession();
        if (!restored) {
            loadRooms();
            showLobby();
        }
    })();
</script>
</body>
</html>